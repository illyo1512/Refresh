<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GraphHopper ë„¤ë¹„ê²Œì´ì…˜ í…ŒìŠ¤íŠ¸</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }
        .content {
            display: flex;
            min-height: 700px;
        }
        .sidebar {
            width: 420px;
            padding: 20px;
            border-right: 1px solid #eee;
            overflow-y: auto;
        }
        .map-container {
            flex: 1;
            position: relative;
        }
        #map {
            height: 700px;
            width: 100%;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }
        input[type="number"], select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }
        .btn {
            background: #667eea;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
            transition: background 0.3s;
        }
        .btn:hover {
            background: #5a6fd8;
        }
        .btn-success {
            background: #28a745;
        }
        .btn-success:hover {
            background: #218838;
        }
        .btn-warning {
            background: #ffc107;
            color: #212529;
        }
        .btn-warning:hover {
            background: #e0a800;
        }
        .btn-danger {
            background: #dc3545;
        }
        .btn-danger:hover {
            background: #c82333;
        }
        .btn-info {
            background: #17a2b8;
        }
        .btn-info:hover {
            background: #138496;
        }
        .btn-secondary {
            background: #6c757d;
        }
        .btn-secondary:hover {
            background: #5a6268;
        }
        .result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 4px;
            font-size: 14px;
        }
        .result.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .result.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .result.warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }
        .result.info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        .route-info {
            margin: 10px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
            border-left: 4px solid #667eea;
        }
        .route-info h4 {
            margin: 0 0 8px 0;
            color: #667eea;
        }
        .route-stats {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
            font-size: 12px;
        }
        .preset-locations {
            margin-bottom: 20px;
        }
        .preset-btn {
            background: #6c757d;
            font-size: 12px;
            padding: 6px 12px;
            margin: 2px;
        }
        .preset-btn:hover {
            background: #5a6268;
        }
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .status-indicator {
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 15px;
            text-align: center;
        }
        .status-ready {
            background: #28a745;
            color: white;
        }
        .status-error {
            background: #dc3545;
            color: white;
        }
        .status-warning {
            background: #ffc107;
            color: #212529;
        }
        .directions-list {
            max-height: 200px;
            overflow-y: auto;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
        }
        .directions-list ol {
            margin: 0;
            padding-left: 20px;
        }
        .directions-list li {
            margin: 5px 0;
            font-size: 12px;
            line-height: 1.4;
        }
        .api-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 5px;
            margin: 10px 0;
        }
        .api-btn {
            padding: 8px 12px;
            font-size: 12px;
        }
        .profiles-info {
            background: #e9ecef;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
            font-size: 11px;
        }
        .profiles-info h4 {
            margin: 0 0 8px 0;
            color: #495057;
        }
        .profiles-info ul {
            margin: 0;
            padding-left: 16px;
        }
        .profiles-info li {
            margin: 2px 0;
        }
        .comparison-stats {
            background: #fff3cd;
            padding: 8px;
            border-radius: 4px;
            margin: 5px 0;
            font-size: 11px;
        }
        .connection-info {
            background: #f8f9fa;
            padding: 8px;
            border-radius: 4px;
            margin-bottom: 15px;
            font-size: 11px;
            border-left: 3px solid #17a2b8;
        }
        .emoji-marker {
            background: none;
            border: none;
            text-align: center;
            font-size: 16px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ—ºï¸ GraphHopper ë„¤ë¹„ê²Œì´ì…˜ í…ŒìŠ¤íŠ¸</h1>
            <p>ìœ„í—˜ì§€ì—­ íšŒí”¼ ì‹œìŠ¤í…œ</p>
        </div>
        
        <div class="content">
            <div class="sidebar">
                <div id="statusIndicator" class="status-indicator status-ready">
                    âœ… ì‹œìŠ¤í…œ ì¤€ë¹„ ì™„ë£Œ
                </div>

                <div class="connection-info">
                    <strong>ğŸŒ ì—°ê²° ì •ë³´</strong><br>
                    API ì„œë²„: http://localhost:9806<br>
                    ìƒíƒœ: ëŒ€ê¸° ì¤‘
                </div>

                <div class="profiles-info">
                    <h4>ğŸ›£ï¸ ì‚¬ìš© ê°€ëŠ¥í•œ í”„ë¡œí•„</h4>
                    <ul>
                        <li><strong>foot_fastest:</strong> ë³´í–‰ì ìµœë‹¨ê±°ë¦¬</li>
                        <li><strong>foot_avoid:</strong> ë³´í–‰ì ìœ„í—˜ì§€ì—­ íšŒí”¼</li>
                        <li><strong>car_fastest:</strong> ìë™ì°¨ ìµœë‹¨ê±°ë¦¬</li>
                        <li><strong>car_avoid:</strong> ìë™ì°¨ ìœ„í—˜ì§€ì—­ íšŒí”¼</li>
                    </ul>
                </div>

                <div class="preset-locations">
                    <h3>ğŸ“ ë¹ ë¥¸ ìœ„ì¹˜ ì„¤ì •</h3>
                    <button class="btn preset-btn" onclick="setPreset('gangnam')">ê°•ë‚¨ì—­ â†’ í™ëŒ€</button>
                    <button class="btn preset-btn" onclick="setPreset('hongdae')">í™ëŒ€ â†’ ëª…ë™</button>
                    <button class="btn preset-btn" onclick="setPreset('myeongdong')">ëª…ë™ â†’ ì´íƒœì›</button>
                    <button class="btn preset-btn" onclick="setPreset('itaewon')">ì´íƒœì› â†’ ê°•ë‚¨</button>
                </div>

                <form id="routeForm">
                    <div class="form-group">
                        <label>ğŸš€ ì¶œë°œì§€ ìœ„ë„</label>
                        <input type="number" id="startLat" step="0.000001" placeholder="37.497175" value="37.497175">
                    </div>
                    
                    <div class="form-group">
                        <label>ğŸš€ ì¶œë°œì§€ ê²½ë„</label>
                        <input type="number" id="startLng" step="0.000001" placeholder="127.027926" value="127.027926">
                    </div>
                    
                    <div class="form-group">
                        <label>ğŸ ë„ì°©ì§€ ìœ„ë„</label>
                        <input type="number" id="endLat" step="0.000001" placeholder="37.556785" value="37.556785">
                    </div>
                    
                    <div class="form-group">
                        <label>ğŸ ë„ì°©ì§€ ê²½ë„</label>
                        <input type="number" id="endLng" step="0.000001" placeholder="126.924347" value="126.924347">
                    </div>
                    
                    <div class="form-group">
                        <label>ğŸš— êµí†µìˆ˜ë‹¨</label>
                        <select id="transportMode">
                            <option value="foot">ë„ë³´</option>
                            <option value="car">ìë™ì°¨</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>ğŸ›£ï¸ API ê¸°ëŠ¥</label>
                        <div class="api-buttons">
                            <button type="button" class="btn api-btn btn-success" onclick="calculateBasicRoute()">
                                ğŸ“ ê¸°ë³¸ ê²½ë¡œ
                            </button>
                            <button type="button" class="btn api-btn btn-info" onclick="analyzeRoute()">
                                ğŸ” ê²½ë¡œ ë¶„ì„
                            </button>
                            <button type="button" class="btn api-btn btn-warning" onclick="compareRoutes()">
                                âš–ï¸ ê²½ë¡œ ë¹„êµ
                            </button>
                            <button type="button" class="btn api-btn btn-success" onclick="calculateWalkingRoute()">
                                ğŸš¶ ë³´í–‰ì ê²½ë¡œ
                            </button>
                            <button type="button" class="btn api-btn btn-danger" onclick="calculateDrivingRoute()">
                                ğŸš— ìë™ì°¨ ê²½ë¡œ
                            </button>
                            <button type="button" class="btn api-btn btn-secondary" onclick="getProfiles()">
                                ğŸ“‹ í”„ë¡œí•„ ëª©ë¡
                            </button>
                            <button type="button" class="btn api-btn btn-info" onclick="checkHealth()">
                                ğŸ©º í—¬ìŠ¤ ì²´í¬
                            </button>
                            <button type="button" class="btn api-btn" onclick="clearMap()">
                                ğŸ—‘ï¸ ì§€ë„ ì´ˆê¸°í™”
                            </button>
                        </div>
                    </div>
                </form>

                <div class="loading" id="loading">
                    <div class="spinner"></div>
                    <p>ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤...</p>
                </div>

                <div id="result"></div>
            </div>
            
            <div class="map-container">
                <div id="map"></div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // API ë² ì´ìŠ¤ URL ê³ ì •
        const API_BASE_URL = 'http://localhost:9806';

        // ì „ì—­ ë³€ìˆ˜
        let map;
        let startMarker = null;
        let endMarker = null;
        let routeLayers = [];

        // ìƒ‰ìƒ ë§¤í•‘
        const profileColors = {
            'foot_fastest': '#007bff',
            'foot_avoid': '#28a745',
            'car_fastest': '#ffc107',
            'car_avoid': '#dc3545'
        };

        // ì‚¬ì „ ì •ì˜ëœ ìœ„ì¹˜ë“¤
        const presetLocations = {
            gangnam: { start: [37.497175, 127.027926], end: [37.556785, 126.924347], name: 'ê°•ë‚¨ì—­ â†’ í™ëŒ€ì…êµ¬ì—­' },
            hongdae: { start: [37.556785, 126.924347], end: [37.563600, 126.982908], name: 'í™ëŒ€ì…êµ¬ì—­ â†’ ëª…ë™ì—­' },
            myeongdong: { start: [37.563600, 126.982908], end: [37.534565, 126.994734], name: 'ëª…ë™ì—­ â†’ ì´íƒœì›ì—­' },
            itaewon: { start: [37.534565, 126.994734], end: [37.497175, 127.027926], name: 'ì´íƒœì›ì—­ â†’ ê°•ë‚¨ì—­' }
        };

        // ì§€ë„ ì´ˆê¸°í™”
        function initMap() {
            try {
                map = L.map('map').setView([37.5665, 126.9780], 11);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: 'Â© OpenStreetMap contributors'
                }).addTo(map);
                
                console.log('ì§€ë„ ì´ˆê¸°í™” ì™„ë£Œ');
                updateMarkers();
            } catch (error) {
                console.error('ì§€ë„ ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
                showResult('âŒ ì§€ë„ ì´ˆê¸°í™” ì‹¤íŒ¨: ' + error.message, 'error');
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM ë¡œë“œ ì™„ë£Œ');
            initMap();
            
            // ì…ë ¥ê°’ ë³€ê²½ ì‹œ ë§ˆì»¤ ì—…ë°ì´íŠ¸
            ['startLat', 'startLng', 'endLat', 'endLng'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('change', updateMarkers);
                }
            });
        });

        // ì‚¬ì „ ì •ì˜ ìœ„ì¹˜ ì„¤ì •
        function setPreset(location) {
            try {
                const preset = presetLocations[location];
                if (preset) {
                    document.getElementById('startLat').value = preset.start[0];
                    document.getElementById('startLng').value = preset.start[1];
                    document.getElementById('endLat').value = preset.end[0];
                    document.getElementById('endLng').value = preset.end[1];
                    
                    updateMarkers();
                    showResult(`ğŸ“ ${preset.name} ê²½ë¡œê°€ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
                }
            } catch (error) {
                console.error('í”„ë¦¬ì…‹ ì„¤ì • ì˜¤ë¥˜:', error);
                showResult('âŒ í”„ë¦¬ì…‹ ì„¤ì • ì‹¤íŒ¨', 'error');
            }
        }

        // ë§ˆì»¤ ì—…ë°ì´íŠ¸
        function updateMarkers() {
            try {
                if (!map) {
                    console.log('ì§€ë„ê°€ ì•„ì§ ì´ˆê¸°í™”ë˜ì§€ ì•ŠìŒ');
                    return;
                }

                const startLat = parseFloat(document.getElementById('startLat').value);
                const startLng = parseFloat(document.getElementById('startLng').value);
                const endLat = parseFloat(document.getElementById('endLat').value);
                const endLng = parseFloat(document.getElementById('endLng').value);

                // ê¸°ì¡´ ë§ˆì»¤ ì œê±°
                if (startMarker) {
                    map.removeLayer(startMarker);
                    startMarker = null;
                }
                if (endMarker) {
                    map.removeLayer(endMarker);
                    endMarker = null;
                }

                // ìƒˆ ë§ˆì»¤ ì¶”ê°€
                if (!isNaN(startLat) && !isNaN(startLng)) {
                    startMarker = L.marker([startLat, startLng], {
                        icon: L.divIcon({
                            html: 'ğŸš€',
                            className: 'emoji-marker',
                            iconSize: [20, 20],
                            iconAnchor: [10, 10]
                        })
                    }).addTo(map).bindPopup('ì¶œë°œì§€');
                }

                if (!isNaN(endLat) && !isNaN(endLng)) {
                    endMarker = L.marker([endLat, endLng], {
                        icon: L.divIcon({
                            html: 'ğŸ',
                            className: 'emoji-marker',
                            iconSize: [20, 20],
                            iconAnchor: [10, 10]
                        })
                    }).addTo(map).bindPopup('ë„ì°©ì§€');
                }

                // ì§€ë„ ë²”ìœ„ ì¡°ì •
                if (startMarker && endMarker) {
                    const group = new L.featureGroup([startMarker, endMarker]);
                    map.fitBounds(group.getBounds().pad(0.1));
                }
            } catch (error) {
                console.error('ë§ˆì»¤ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', error);
            }
        }

        // ê¸°ë³¸ ê²½ë¡œ ê³„ì‚°
        async function calculateBasicRoute() {
            const params = getRouteParams();
            if (!params) return;

            const profile = params.transportMode === 'car' ? 'car_avoid' : 'foot_avoid';
            params.profile = profile;
            delete params.transportMode;

            await makeRequest(`${API_BASE_URL}/api/navigation/route`, params, displayBasicRouteResult);
        }

        // ê²½ë¡œ ë¶„ì„
        async function analyzeRoute() {
            const params = getRouteParams();
            if (!params) return;

            const profile = params.transportMode === 'car' ? 'car_avoid' : 'foot_avoid';
            params.profile = profile;
            delete params.transportMode;

            await makeRequest(`${API_BASE_URL}/api/navigation/analyze`, params, displayAnalysisResult);
        }

        // ê²½ë¡œ ë¹„êµ
        async function compareRoutes() {
            const params = getRouteParams();
            if (!params) return;

            await makeRequest(`${API_BASE_URL}/api/navigation/compare`, params, displayComparisonResult);
        }

        // ë³´í–‰ì ê²½ë¡œ
        async function calculateWalkingRoute() {
            const params = getRouteParams();
            if (!params) return;

            delete params.transportMode;
            await makeRequest(`${API_BASE_URL}/api/navigation/walking`, params, displayWalkingResult);
        }

        // ìë™ì°¨ ê²½ë¡œ
        async function calculateDrivingRoute() {
            const params = getRouteParams();
            if (!params) return;

            delete params.transportMode;
            await makeRequest(`${API_BASE_URL}/api/navigation/driving`, params, displayDrivingResult);
        }

        // í”„ë¡œí•„ ëª©ë¡ ì¡°íšŒ
        async function getProfiles() {
            showLoading(true);
            try {
                const response = await fetch(`${API_BASE_URL}/api/navigation/profiles`);
                const data = await response.json();
                
                if (data && data.success) {
                    displayProfilesResult(data);
                } else {
                    showResult('âŒ í”„ë¡œí•„ ì¡°íšŒ ì‹¤íŒ¨', 'error');
                }
            } catch (error) {
                console.error('í”„ë¡œí•„ ì¡°íšŒ ì˜¤ë¥˜:', error);
                showResult(`âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${error.message}`, 'error');
            } finally {
                showLoading(false);
            }
        }

        // í—¬ìŠ¤ ì²´í¬
        async function checkHealth() {
            showLoading(true);
            try {
                const response = await fetch(`${API_BASE_URL}/api/navigation/health`);
                const data = await response.json();
                displayHealthResult(data);
            } catch (error) {
                console.error('í—¬ìŠ¤ ì²´í¬ ì˜¤ë¥˜:', error);
                showResult(`âŒ í—¬ìŠ¤ ì²´í¬ ì‹¤íŒ¨: ${error.message}`, 'error');
            } finally {
                showLoading(false);
            }
        }

        // ê³µí†µ ìš”ì²­ í•¨ìˆ˜
        async function makeRequest(url, params, displayFunction) {
            showLoading(true);
            
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams(params)
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                
                if (data && data.success) {
                    displayFunction(data);
                } else {
                    showResult(`âŒ ì˜¤ë¥˜: ${data?.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`, 'error');
                    
                    // í”„ë¡œí•„ ì˜¤ë¥˜ ì‹œ ì‚¬ìš© ê°€ëŠ¥í•œ í”„ë¡œí•„ í‘œì‹œ
                    if (data && data.availableProfiles) {
                        let profilesHtml = '<br>ì‚¬ìš© ê°€ëŠ¥í•œ í”„ë¡œí•„:<br>';
                        Object.entries(data.availableProfiles).forEach(([key, value]) => {
                            profilesHtml += `<strong>${key}:</strong> ${value}<br>`;
                        });
                        document.getElementById('result').innerHTML += profilesHtml;
                    }
                }
            } catch (error) {
                console.error('ìš”ì²­ ì˜¤ë¥˜:', error);
                showResult(`âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${error.message}<br>ì„œë²„ê°€ localhost:9806ì—ì„œ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸í•˜ì„¸ìš”.`, 'error');
            } finally {
                showLoading(false);
            }
        }

        // ê²½ë¡œ íŒŒë¼ë¯¸í„° ê°€ì ¸ì˜¤ê¸°
        function getRouteParams() {
            try {
                const startLat = parseFloat(document.getElementById('startLat').value);
                const startLng = parseFloat(document.getElementById('startLng').value);
                const endLat = parseFloat(document.getElementById('endLat').value);
                const endLng = parseFloat(document.getElementById('endLng').value);
                const transportMode = document.getElementById('transportMode').value;

                if (isNaN(startLat) || isNaN(startLng) || isNaN(endLat) || isNaN(endLng)) {
                    showResult('âŒ ëª¨ë“  ì¢Œí‘œë¥¼ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                    return null;
                }

                return { startLat, startLng, endLat, endLng, transportMode };
            } catch (error) {
                console.error('íŒŒë¼ë¯¸í„° ê°€ì ¸ì˜¤ê¸° ì˜¤ë¥˜:', error);
                showResult('âŒ ì…ë ¥ê°’ ì²˜ë¦¬ ì˜¤ë¥˜', 'error');
                return null;
            }
        }

        // ê¸°ë³¸ ê²½ë¡œ ê²°ê³¼ í‘œì‹œ
        function displayBasicRouteResult(data) {
            clearRoutes();
            
            const color = profileColors[data.profile] || '#007bff';
            let resultHtml = `<div class="result success">`;
            resultHtml += `<h3>ğŸ“ ê¸°ë³¸ ê²½ë¡œ ê³„ì‚° ì™„ë£Œ</h3>`;
            resultHtml += createRouteInfoHtml(data, color, data.profileDescription || 'ê¸°ë³¸ ê²½ë¡œ');
            resultHtml += `</div>`;
            
            document.getElementById('result').innerHTML = resultHtml;
            displayRouteOnMap(data.wkt, color, data.profileDescription || 'ê¸°ë³¸ ê²½ë¡œ');
        }

        // ê²½ë¡œ ë¶„ì„ ê²°ê³¼ í‘œì‹œ
        function displayAnalysisResult(data) {
            clearRoutes();
            
            const color = profileColors[data.profile] || '#17a2b8';
            let resultHtml = `<div class="result info">`;
            resultHtml += `<h3>ğŸ” ê²½ë¡œ ë¶„ì„ ì™„ë£Œ</h3>`;
            resultHtml += createRouteInfoHtml(data, color, data.profileDescription || 'ë¶„ì„ëœ ê²½ë¡œ');
            
            // ê¸¸ì°¾ê¸° ì•ˆë‚´ í‘œì‹œ
            if (data.directions && data.directions.length > 0) {
                resultHtml += `<h4>ğŸ§­ ê¸¸ì°¾ê¸° ì•ˆë‚´ (${data.directions.length}ê°œ)</h4>`;
                resultHtml += `<div class="directions-list">`;
                resultHtml += `<ol>`;
                data.directions.forEach(direction => {
                    resultHtml += `<li>${direction}</li>`;
                });
                resultHtml += `</ol></div>`;
            }
            
            resultHtml += `</div>`;
            
            document.getElementById('result').innerHTML = resultHtml;
            displayRouteOnMap(data.wkt, color, data.profileDescription || 'ë¶„ì„ëœ ê²½ë¡œ');
        }

        // ê²½ë¡œ ë¹„êµ ê²°ê³¼ í‘œì‹œ
        function displayComparisonResult(data) {
            clearRoutes();
            
            let resultHtml = `<div class="result info">`;
            resultHtml += `<h3>âš–ï¸ ê²½ë¡œ ë¹„êµ ê²°ê³¼ (${data.transportModeDescription})</h3>`;
            
            // ìµœë‹¨ ê²½ë¡œ
            const fastestColor = profileColors[data.fastestRoute.profile] || '#007bff';
            resultHtml += createRouteInfoHtml(data.fastestRoute, fastestColor, data.fastestRoute.profileDescription);
            displayRouteOnMap(data.fastestRoute.wkt, fastestColor, data.fastestRoute.profileDescription);
            
            // íšŒí”¼ ê²½ë¡œ
            const avoidColor = profileColors[data.avoidRoute.profile] || '#28a745';
            resultHtml += createRouteInfoHtml(data.avoidRoute, avoidColor, data.avoidRoute.profileDescription);
            displayRouteOnMap(data.avoidRoute.wkt, avoidColor, data.avoidRoute.profileDescription);
            
            // ë¹„êµ ì •ë³´
            const comp = data.comparison;
            resultHtml += `<div class="comparison-stats">`;
            resultHtml += `<h4>ğŸ“Š ê²½ë¡œ ë¹„êµ ê²°ê³¼</h4>`;
            resultHtml += `<div class="route-stats">`;
            resultHtml += `<span>ê±°ë¦¬ ì°¨ì´: ${comp.distanceDifferenceKm > 0 ? '+' : ''}${comp.distanceDifferenceKm}km (${comp.distancePercentDifference > 0 ? '+' : ''}${comp.distancePercentDifference}%)</span>`;
            resultHtml += `</div>`;
            resultHtml += `<div class="route-stats">`;
            resultHtml += `<span>ì‹œê°„ ì°¨ì´: ${comp.timeDifferenceMinutes > 0 ? '+' : ''}${comp.timeDifferenceMinutes}ë¶„ (${comp.timePercentDifference > 0 ? '+' : ''}${comp.timePercentDifference}%)</span>`;
            resultHtml += `</div>`;
            resultHtml += `<div class="route-stats">`;
            resultHtml += `<span>${comp.isAvoidLonger ? 'âš ï¸ íšŒí”¼ê²½ë¡œê°€ ë” ê¸¸ì§€ë§Œ ì•ˆì „í•©ë‹ˆë‹¤' : 'âœ… íšŒí”¼ê²½ë¡œê°€ ë” ì§§ìŠµë‹ˆë‹¤'}</span>`;
            resultHtml += `</div>`;
            resultHtml += `</div>`;
            
            resultHtml += `</div>`;
            document.getElementById('result').innerHTML = resultHtml;
        }

        // ë³´í–‰ì ê²½ë¡œ ê²°ê³¼ í‘œì‹œ
        function displayWalkingResult(data) {
            clearRoutes();
            
            let resultHtml = `<div class="result success">`;
            resultHtml += `<h3>ğŸš¶ ë³´í–‰ì ê²½ë¡œ ì™„ë£Œ</h3>`;
            resultHtml += createRouteInfoHtml(data, '#28a745', data.profileDescription || 'ë³´í–‰ì ê²½ë¡œ');
            resultHtml += `</div>`;
            
            document.getElementById('result').innerHTML = resultHtml;
            displayRouteOnMap(data.wkt, '#28a745', data.profileDescription || 'ë³´í–‰ì ê²½ë¡œ');
        }

        // ìë™ì°¨ ê²½ë¡œ ê²°ê³¼ í‘œì‹œ
        function displayDrivingResult(data) {
            clearRoutes();
            
            let resultHtml = `<div class="result success">`;
            resultHtml += `<h3>ğŸš— ìë™ì°¨ ê²½ë¡œ ì™„ë£Œ</h3>`;
            resultHtml += createRouteInfoHtml(data, '#dc3545', data.profileDescription || 'ìë™ì°¨ ê²½ë¡œ');
            resultHtml += `</div>`;
            
            document.getElementById('result').innerHTML = resultHtml;
            displayRouteOnMap(data.wkt, '#dc3545', data.profileDescription || 'ìë™ì°¨ ê²½ë¡œ');
        }

        // í”„ë¡œí•„ ê²°ê³¼ í‘œì‹œ
        function displayProfilesResult(data) {
            let resultHtml = `<div class="result info">`;
            resultHtml += `<h3>ğŸ“‹ ì‚¬ìš© ê°€ëŠ¥í•œ í”„ë¡œí•„</h3>`;
            
            resultHtml += `<h4>ì„¤ì •ëœ í”„ë¡œí•„ (${data.profileCount}ê°œ)</h4>`;
            Object.entries(data.profiles).forEach(([key, value]) => {
                resultHtml += `<div class="route-stats"><span><strong>${key}:</strong> ${value}</span></div>`;
            });
            
            if (data.actualProfiles) {
                resultHtml += `<h4>ì‹¤ì œ ë¡œë“œëœ í”„ë¡œí•„ (${data.actualProfileCount}ê°œ)</h4>`;
                resultHtml += `<div style="font-size: 12px; color: #666;">${data.actualProfiles.join(', ')}</div>`;
            }
            
            resultHtml += `</div>`;
            document.getElementById('result').innerHTML = resultHtml;
        }

        // í—¬ìŠ¤ ì²´í¬ ê²°ê³¼ í‘œì‹œ
        function displayHealthResult(data) {
            const isHealthy = data.status === 'UP';
            let resultHtml = `<div class="result ${isHealthy ? 'success' : 'error'}">`;
            resultHtml += `<h3>ğŸ©º ì‹œìŠ¤í…œ í—¬ìŠ¤ ì²´í¬</h3>`;
            resultHtml += `<div class="route-stats">`;
            resultHtml += `<span>ìƒíƒœ: <strong>${data.status}</strong></span>`;
            resultHtml += `<span>ì„œë¹„ìŠ¤: ${data.serviceHealthy ? 'âœ… ì •ìƒ' : 'âŒ ì´ìƒ'}</span>`;
            resultHtml += `</div>`;
            
            if (data.availableProfiles) {
                resultHtml += `<div class="route-stats">`;
                resultHtml += `<span>í”„ë¡œí•„: ${data.profileCount}ê°œ ë¡œë“œë¨</span>`;
                resultHtml += `</div>`;
                resultHtml += `<div style="font-size: 11px; color: #666; margin-top: 5px;">`;
                resultHtml += `${data.availableProfiles.join(', ')}`;
                resultHtml += `</div>`;
            }
            
            resultHtml += `<div style="margin-top: 10px; font-size: 12px; color: #666;">`;
            resultHtml += `${data.message || ''}`;
            resultHtml += `</div>`;
            
            resultHtml += `</div>`;
            document.getElementById('result').innerHTML = resultHtml;
        }

        // ê²½ë¡œ ì •ë³´ HTML ìƒì„±
        function createRouteInfoHtml(route, color, description) {
            return `
                <div class="route-info" style="border-left-color: ${color}">
                    <h4 style="color: ${color}">${description}</h4>
                    <div class="route-stats">
                        <span>ê±°ë¦¬: ${route.distanceKm ? route.distanceKm.toFixed(2) : (route.distance / 1000).toFixed(2)}km</span>
                        <span>ì‹œê°„: ${route.timeMinutes || Math.round(route.time / 60000)}ë¶„</span>
                    </div>
                    <div class="route-stats">
                        <span>í”„ë¡œí•„: ${route.profile}</span>
                        <span>ì¢Œí‘œì : ${route.totalPoints || 'N/A'}ê°œ</span>
                    </div>
                    ${route.directionsCount ? `<div class="route-stats"><span>ì•ˆë‚´: ${route.directionsCount}ê°œ</span></div>` : ''}
                </div>
            `;
        }

        // ì§€ë„ì— ê²½ë¡œ í‘œì‹œ
        function displayRouteOnMap(wkt, color, popupText) {
            try {
                if (!map) {
                    console.log('ì§€ë„ê°€ ì´ˆê¸°í™”ë˜ì§€ ì•ŠìŒ');
                    return;
                }

                const coords = parseWKTLineString(wkt);
                if (coords.length > 0) {
                    const polyline = L.polyline(coords, {
                        color: color,
                        weight: 4,
                        opacity: 0.8
                    }).addTo(map);
                    
                    if (popupText) {
                        polyline.bindPopup(popupText);
                    }
                    
                    routeLayers.push(polyline);
                    
                    if (routeLayers.length === 1) {
                        map.fitBounds(polyline.getBounds().pad(0.1));
                    }
                }
            } catch (error) {
                console.error('ê²½ë¡œ í‘œì‹œ ì˜¤ë¥˜:', error);
            }
        }

        // WKT LINESTRING íŒŒì‹±
        function parseWKTLineString(wkt) {
            try {
                const coordStr = wkt.replace('LINESTRING (', '').replace(')', '');
                const pairs = coordStr.split(', ');
                return pairs.map(pair => {
                    const [lng, lat] = pair.split(' ').map(Number);
                    return [lat, lng];
                });
            } catch (error) {
                console.error('WKT íŒŒì‹± ì˜¤ë¥˜:', error);
                return [];
            }
        }

        // ê²½ë¡œ ì´ˆê¸°í™”
        function clearRoutes() {
            try {
                if (map && routeLayers.length > 0) {
                    routeLayers.forEach(layer => map.removeLayer(layer));
                    routeLayers = [];
                }
            } catch (error) {
                console.error('ê²½ë¡œ ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
            }
        }

        // ì§€ë„ ì „ì²´ ì´ˆê¸°í™”
        function clearMap() {
            try {
                clearRoutes();
                if (map && startMarker) {
                    map.removeLayer(startMarker);
                    startMarker = null;
                }
                if (map && endMarker) {
                    map.removeLayer(endMarker);
                    endMarker = null;
                }
                document.getElementById('result').innerHTML = '';
                showResult('ğŸ—‘ï¸ ì§€ë„ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            } catch (error) {
                console.error('ì§€ë„ ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
                showResult('âŒ ì§€ë„ ì´ˆê¸°í™” ì‹¤íŒ¨', 'error');
            }
        }

        // ë¡œë”© í‘œì‹œ
        function showLoading(show) {
            try {
                const loadingElement = document.getElementById('loading');
                if (loadingElement) {
                    loadingElement.style.display = show ? 'block' : 'none';
                }
            } catch (error) {
                console.error('ë¡œë”© í‘œì‹œ ì˜¤ë¥˜:', error);
            }
        }

        // ê²°ê³¼ ë©”ì‹œì§€ í‘œì‹œ
        function showResult(message, type) {
            try {
                const resultElement = document.getElementById('result');
                if (resultElement) {
                    resultElement.innerHTML = `<div class="result ${type}">${message}</div>`;
                }
            } catch (error) {
                console.error('ê²°ê³¼ í‘œì‹œ ì˜¤ë¥˜:', error);
            }
        }
    </script>
</body>
</html>