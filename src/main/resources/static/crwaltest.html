<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Python í¬ë¡¤ë§ + AI í…ŒìŠ¤íŠ¸</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 1000px; 
            margin: 0 auto; 
            padding: 20px; 
            background: #f5f5f5; 
        }
        .container { 
            background: white; 
            padding: 20px; 
            border-radius: 8px; 
            margin-bottom: 15px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); 
        }
        .input-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input[type="text"] { 
            width: 100%; 
            padding: 8px; 
            border: 1px solid #ddd; 
            border-radius: 4px; 
            box-sizing: border-box; 
        }
        button { 
            background: #007bff; 
            color: white; 
            border: none; 
            padding: 10px 15px; 
            border-radius: 4px; 
            cursor: pointer; 
            margin: 5px; 
        }
        button:hover:not(:disabled) { background: #0056b3; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        .btn-success { background: #28a745; }
        .btn-success:hover:not(:disabled) { background: #218838; }
        .btn-warning { background: #ffc107; color: #000; }
        .btn-warning:hover:not(:disabled) { background: #e0a800; }
        .btn-secondary { background: #6c757d; }
        .btn-secondary:hover:not(:disabled) { background: #545b62; }
        .btn-danger { background: #dc3545; }
        .btn-danger:hover:not(:disabled) { background: #c82333; }
        #result { 
            background: #f8f9fa; 
            border: 1px solid #ddd; 
            padding: 15px; 
            border-radius: 4px; 
            min-height: 100px; 
            white-space: pre-wrap; 
            font-family: monospace; 
            max-height: 600px; 
            overflow-y: auto; 
        }
        #socketResult { 
            background: #f8f9fa; 
            border: 1px solid #ddd; 
            padding: 15px; 
            border-radius: 4px; 
            min-height: 100px; 
            max-height: 300px; 
            overflow-y: auto; 
            font-family: monospace; 
            font-size: 12px;
        }
        .loading { color: #007bff; font-weight: bold; }
        .error { color: #dc3545; }
        .success { color: #28a745; }
        .socket-connected { color: #28a745; font-weight: bold; }
        .socket-disconnected { color: #dc3545; font-weight: bold; }
        .socket-message { color: #007bff; }
        .button-group { display: flex; flex-wrap: wrap; gap: 5px; }
        .range-input { 
            width: 200px; 
            display: inline-block; 
            margin-right: 10px; 
        }
    </style>
</head>
<body>
    <h1>ğŸ Python í¬ë¡¤ë§ + AI í…ŒìŠ¤íŠ¸</h1>
    
    <div class="container">
        <h3>âš™ï¸ ì„œë²„ ì„¤ì •</h3>
        <div class="input-group">
            <label for="serverUrl">ì„œë²„ ì£¼ì†Œ:</label>
            <input type="text" id="serverUrl" value="http://localhost:9806" placeholder="ì˜ˆ: http://localhost:9806">
            <button onclick="setPresetUrl('http://localhost:9806')">ë¡œì»¬ ì„œë²„</button>
            <button class="btn-secondary" onclick="testConnection()">ì—°ê²° í…ŒìŠ¤íŠ¸</button>
        </div>
    </div>

    <!-- WebSocket í…ŒìŠ¤íŠ¸ ì„¹ì…˜ ìˆ˜ì • -->   
    <div class="container">
        <h3>ğŸ”Œ WebSocket ì‹¤ì‹œê°„ ì•Œë¦¼ í…ŒìŠ¤íŠ¸</h3>
        <div class="button-group">
            <button id="socketConnectBtn" class="btn-success" onclick="connectWebSocket()">ğŸ”— ì†Œì¼“ ì—°ê²°</button>
            <button id="socketDisconnectBtn" class="btn-danger" onclick="disconnectWebSocket()" disabled>âŒ ì†Œì¼“ ì—°ê²° í•´ì œ</button>
            <button onclick="sendTestAlert()">ğŸ“¢ ê¸°ë³¸ í…ŒìŠ¤íŠ¸ ì•Œë¦¼</button>
            <button onclick="sendCustomAlert()">ğŸ“ ì»¤ìŠ¤í…€ ì•Œë¦¼</button>
            <button onclick="sendMultipleAlerts()">ğŸ“Š ë‹¤ì¤‘ ì•Œë¦¼</button>
            <button onclick="sendDangerLevelAlerts()">âš ï¸ ìœ„í—˜ë„ë³„ ì•Œë¦¼</button>
            <button onclick="clearSocketLog()">ğŸ—‘ï¸ ë¡œê·¸ ì§€ìš°ê¸°</button>
        </div>
        
        <!-- ì»¤ìŠ¤í…€ ì•Œë¦¼ ì…ë ¥ í•„ë“œ ì¶”ê°€ -->
        <div class="input-group" style="margin-top: 10px;">
            <label for="customMessage">ì»¤ìŠ¤í…€ ì•Œë¦¼ ë©”ì‹œì§€:</label>
            <input type="text" id="customMessage" placeholder="ì˜ˆ: ê°•ë‚¨êµ¬ì—ì„œ ê°•ë„ ì‚¬ê±´ ë°œìƒ" value="ê°•ë‚¨êµ¬ì—ì„œ ê°•ë„ ì‚¬ê±´ì´ ë°œìƒí–ˆìŠµë‹ˆë‹¤.">
            <label for="customDangerLevel" style="margin-top: 10px;">ìœ„í—˜ë„ (1-5):</label>
            <input type="number" id="customDangerLevel" min="1" max="5" value="1" style="width: 100px;">
        </div>
        
        <!-- ë‹¤ì¤‘ ì•Œë¦¼ ì„¤ì • -->
        <div class="input-group">
            <label for="alertCount">ë‹¤ì¤‘ ì•Œë¦¼ ê°œìˆ˜:</label>
            <input type="number" id="alertCount" min="1" max="10" value="3" style="width: 100px; margin-right: 10px;">
            <label for="alertInterval">ê°„ê²© (ë°€ë¦¬ì´ˆ):</label>
            <input type="number" id="alertInterval" min="500" max="10000" value="2000" style="width: 100px;">
        </div>
        
        <p><span id="socketStatus" class="socket-disconnected">ì—°ê²° í•´ì œë¨</span></p>
        <div id="socketResult">WebSocket ì—°ê²° ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ì‹¤ì‹œê°„ ì•Œë¦¼ì„ í…ŒìŠ¤íŠ¸í•˜ì„¸ìš”.

ğŸ“‹ ì‚¬ìš©ë²•:
1. 'ì†Œì¼“ ì—°ê²°' ë²„íŠ¼ í´ë¦­
2. ë‹¤ì–‘í•œ í…ŒìŠ¤íŠ¸ ë²„íŠ¼ìœ¼ë¡œ WebSocket ê¸°ëŠ¥ í™•ì¸
3. 'í¬ë¡¤ë§ + AI í†µí•© ì‹¤í–‰'ìœ¼ë¡œ ì‹¤ì œ ì•Œë¦¼ í™•ì¸</div>
    </div>
    
    <div class="container">
        <h3>ğŸš€ ê¸°ë³¸ ì‹¤í–‰</h3>
        <div class="button-group">
            <button id="crawlingBtn" onclick="executeCrawling()">ğŸ•·ï¸ í¬ë¡¤ë§ë§Œ ì‹¤í–‰</button>
            <button id="combinedBtn" class="btn-success" onclick="executeCrawlingWithAI()">ğŸ¯ í¬ë¡¤ë§ + AI í†µí•© ì‹¤í–‰</button>
        </div>
    </div>

    <div class="container">
        <h3>ğŸ¤– AI í‚¤ì›Œë“œ ì¶”ì¶œ ì„¤ì •</h3>
        <div class="input-group">
            <label for="articleDirectory">ê¸°ì‚¬ ë””ë ‰í† ë¦¬:</label>
            <input type="text" id="articleDirectory" value="../../data/crawling/naver_articles">
        </div>
        <div class="input-group">
            <label for="rangeInput">ì²˜ë¦¬ ë²”ìœ„ (ì„ íƒì‚¬í•­):</label>
            <input type="text" id="rangeInput" class="range-input" placeholder="ì˜ˆ: 1-5, 1,3,5, all">
            <input type="number" id="crawlNumInput" class="range-input" placeholder="í¬ë¡¤ë§ ê°œìˆ˜" min="1">
        </div>
        <div class="button-group">
            <button id="aiBtn" class="btn-warning" onclick="executeAiKeyword()">ğŸ¤– AI í‚¤ì›Œë“œ ì¶”ì¶œ</button>
            <button onclick="executeAiWithRange()">ğŸ“ ë²”ìœ„ ì§€ì • ì‹¤í–‰</button>
            <button onclick="executeAiWithCrawlNum()">ğŸ”¢ ê°œìˆ˜ ê¸°ë°˜ ì‹¤í–‰</button>
        </div>
        <p style="font-size: 12px; color: #666;">
            ğŸ’¡ íŒ: ë²”ìœ„ ì˜ˆì‹œ - "1-5" (1~5ë²ˆ), "1,3,5" (1,3,5ë²ˆë§Œ), "all" (ì „ì²´)
        </p>
    </div>

    <div class="container">
        <h3>ğŸ“Š ì‹¤í–‰ ê²°ê³¼</h3>
        <div id="result">ì‹¤í–‰ ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ í…ŒìŠ¤íŠ¸ë¥¼ ì‹œì‘í•˜ì„¸ìš”.

ğŸ“‹ ì‚¬ìš© ê°€ì´ë“œ:
- í¬ë¡¤ë§ë§Œ ì‹¤í–‰: ë„¤ì´ë²„ ë‰´ìŠ¤ í¬ë¡¤ë§
- í†µí•© ì‹¤í–‰: í¬ë¡¤ë§ í›„ ìƒˆ ê¸°ì‚¬ ìë™ AI ì²˜ë¦¬  
- AI í‚¤ì›Œë“œ ì¶”ì¶œ: ê¸°ì¡´ íŒŒì¼ì—ì„œ í‚¤ì›Œë“œ ì¶”ì¶œ
- ë²”ìœ„/ê°œìˆ˜ ì§€ì •: íŠ¹ì • íŒŒì¼ë§Œ ì²˜ë¦¬</div>
    </div>

    <!-- CDN ë¼ì´ë¸ŒëŸ¬ë¦¬ ì¶”ê°€ -->
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@stomp/stompjs@7/bundles/stomp.umd.min.js"></script>

    <script>
        // WebSocket ê´€ë ¨ ë³€ìˆ˜
        let stompClient = null;
        let socket = null;

        function setPresetUrl(url) {
            document.getElementById('serverUrl').value = url;
        }

        function getServerUrl() {
            const serverUrl = document.getElementById('serverUrl').value.trim();
            if (!serverUrl) {
                alert('ì„œë²„ ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return null;
            }
            return serverUrl.startsWith('http') ? serverUrl : 'http://' + serverUrl;
        }

        function testConnection() {
            const serverUrl = getServerUrl();
            if (!serverUrl) return;

            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = '<div class="loading">ğŸ” ì—°ê²° í…ŒìŠ¤íŠ¸ ì¤‘...</div>';

            fetch(serverUrl + '/actuator/health', { method: 'GET', mode: 'cors' })
                .then(response => {
                    if (response.ok) {
                        resultDiv.innerHTML = `<div class="success">âœ… ì„œë²„ ì—°ê²° ì„±ê³µ</div><pre>ì„œë²„: ${serverUrl}</pre>`;
                    } else {
                        resultDiv.innerHTML = `<div class="error">âŒ ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜ (${response.status})</div>`;
                    }
                })
                .catch(error => {
                    resultDiv.innerHTML = `<div class="error">âŒ ì„œë²„ ì—°ê²° ì‹¤íŒ¨: ${error.message}</div>`;
                });
        }

        // ================== WebSocket ê´€ë ¨ í•¨ìˆ˜ ==================

        function connectWebSocket() {
            const serverUrl = getServerUrl();
            if (!serverUrl) return;

            if (stompClient && stompClient.connected) {
                addSocketLog('â— ì´ë¯¸ WebSocketì´ ì—°ê²°ë˜ì–´ ìˆìŠµë‹ˆë‹¤.');
                return;
            }

            try {
                addSocketLog('ğŸ”„ WebSocket ì—°ê²° ì‹œë„ ì¤‘...');
                const sockjsUrl = serverUrl + '/ws-danger-alerts';
                socket = new SockJS(sockjsUrl);
                
                stompClient = new StompJs.Client({
                    webSocketFactory: () => socket,
                    debug: (str) => {
                        console.log('STOMP Debug:', str);
                    },
                    reconnectDelay: 5000,
                    heartbeatIncoming: 4000,
                    heartbeatOutgoing: 4000
                });

                stompClient.onConnect = (frame) => {
                    addSocketLog('âœ… WebSocket ì—°ê²° ì„±ê³µ!');
                    updateSocketStatus(true);
                    
                    // ìœ„í—˜ ì•Œë¦¼ í† í”½ êµ¬ë…
                    stompClient.subscribe('/topic/danger-alerts', (message) => {
                        const dangerAlert = JSON.parse(message.body);
                        const dangerLevelName = getDangerLevelName(dangerAlert.dangerDetailId);
                        
                        addSocketLog(`ğŸš¨ ìœ„í—˜ ì•Œë¦¼ ìˆ˜ì‹ : ${dangerAlert.alertSentence}`);
                        addSocketLog(`   â”” ìœ„í—˜ë„: ${dangerAlert.dangerDetailId} (${dangerLevelName})`);
                        
                        // ë¸Œë¼ìš°ì € ì•Œë¦¼ (ê¶Œí•œì´ ìˆëŠ” ê²½ìš°)
                        if (Notification.permission === 'granted') {
                            new Notification(`ìœ„í—˜ ì•Œë¦¼ - ${dangerLevelName}`, {
                                body: dangerAlert.alertSentence,
                                icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y=".9em" font-size="90">ğŸš¨</text></svg>'
                            });
                        }
                    });
                };

                stompClient.onStompError = (frame) => {
                    addSocketLog(`âŒ STOMP ì˜¤ë¥˜: ${frame.headers['message']}`);
                    addSocketLog(`ìƒì„¸: ${frame.body}`);
                    updateSocketStatus(false);
                };

                stompClient.onWebSocketError = (event) => {
                    addSocketLog(`âŒ WebSocket ì˜¤ë¥˜: ${event}`);
                    updateSocketStatus(false);
                };

                stompClient.onDisconnect = () => {
                    addSocketLog('ğŸ”Œ WebSocket ì—°ê²° í•´ì œë¨');
                    updateSocketStatus(false);
                };

                stompClient.activate();

                // ë¸Œë¼ìš°ì € ì•Œë¦¼ ê¶Œí•œ ìš”ì²­
                if (Notification.permission === 'default') {
                    Notification.requestPermission().then(permission => {
                        if (permission === 'granted') {
                            addSocketLog('ğŸ”” ë¸Œë¼ìš°ì € ì•Œë¦¼ ê¶Œí•œ í—ˆìš©ë¨');
                        }
                    });
                }

            } catch (error) {
                addSocketLog(`âŒ ì—°ê²° ì‹¤íŒ¨: ${error.message}`);
                updateSocketStatus(false);
            }
        }

        function disconnectWebSocket() {
            if (stompClient && stompClient.connected) {
                stompClient.deactivate();
                addSocketLog('ğŸ”Œ WebSocket ì—°ê²°ì„ í•´ì œí–ˆìŠµë‹ˆë‹¤.');
                updateSocketStatus(false);
            } else {
                addSocketLog('â— WebSocketì´ ì—°ê²°ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤.');
            }
        }

        function sendTestAlert() {
            const serverUrl = getServerUrl();
            if (!serverUrl) return;

            addSocketLog('ğŸ“¢ í…ŒìŠ¤íŠ¸ ì•Œë¦¼ ì „ì†¡ ìš”ì²­ ì¤‘...');

            fetch(serverUrl + '/api/test/send-alert', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                mode: 'cors'
            })
            .then(response => response.text())
            .then(data => {
                addSocketLog(`ğŸ“¤ í…ŒìŠ¤íŠ¸ ì•Œë¦¼ ì „ì†¡ ì™„ë£Œ: ${data}`);
            })
            .catch(error => {
                addSocketLog(`âŒ í…ŒìŠ¤íŠ¸ ì•Œë¦¼ ì „ì†¡ ì‹¤íŒ¨: ${error.message}`);
            });
        }

        // ================== ì¶”ê°€ëœ WebSocket í…ŒìŠ¤íŠ¸ í•¨ìˆ˜ë“¤ ==================

        function sendCustomAlert() {
            const serverUrl = getServerUrl();
            if (!serverUrl) return;

            const message = document.getElementById('customMessage').value.trim();
            const dangerLevel = document.getElementById('customDangerLevel').value;

            if (!message) {
                alert('ì»¤ìŠ¤í…€ ë©”ì‹œì§€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            addSocketLog(`ğŸ“ ì»¤ìŠ¤í…€ ì•Œë¦¼ ì „ì†¡ ìš”ì²­... (ë©”ì‹œì§€: ${message}, ìœ„í—˜ë„: ${dangerLevel})`);

            fetch(`${serverUrl}/api/test/send-custom-alert?message=${encodeURIComponent(message)}&dangerLevel=${dangerLevel}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                mode: 'cors'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    addSocketLog(`âœ… ì»¤ìŠ¤í…€ ì•Œë¦¼ ì „ì†¡ ì„±ê³µ: ${data.message}`);
                } else {
                    addSocketLog(`âŒ ì»¤ìŠ¤í…€ ì•Œë¦¼ ì „ì†¡ ì‹¤íŒ¨: ${data.message}`);
                }
            })
            .catch(error => {
                addSocketLog(`âŒ ì»¤ìŠ¤í…€ ì•Œë¦¼ ì „ì†¡ ì˜¤ë¥˜: ${error.message}`);
            });
        }

        function sendMultipleAlerts() {
            const serverUrl = getServerUrl();
            if (!serverUrl) return;

            const count = document.getElementById('alertCount').value;
            const interval = document.getElementById('alertInterval').value;

            if (count < 1 || count > 10) {
                alert('ì•Œë¦¼ ê°œìˆ˜ëŠ” 1~10ê°œ ì‚¬ì´ë¡œ ì„¤ì •í•´ì£¼ì„¸ìš”.');
                return;
            }

            addSocketLog(`ğŸ“Š ë‹¤ì¤‘ ì•Œë¦¼ ì „ì†¡ ì‹œì‘... (${count}ê°œ, ${interval}ms ê°„ê²©)`);

            fetch(`${serverUrl}/api/test/send-multiple-alerts?count=${count}&interval=${interval}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                mode: 'cors'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    addSocketLog(`âœ… ë‹¤ì¤‘ ì•Œë¦¼ ì „ì†¡ ì‹œì‘: ${data.message}`);
                } else {
                    addSocketLog(`âŒ ë‹¤ì¤‘ ì•Œë¦¼ ì „ì†¡ ì‹¤íŒ¨: ${data.message}`);
                }
            })
            .catch(error => {
                addSocketLog(`âŒ ë‹¤ì¤‘ ì•Œë¦¼ ì „ì†¡ ì˜¤ë¥˜: ${error.message}`);
            });
        }

        function sendDangerLevelAlerts() {
            const serverUrl = getServerUrl();
            if (!serverUrl) return;

            addSocketLog('âš ï¸ ìœ„í—˜ë„ë³„ í…ŒìŠ¤íŠ¸ ì•Œë¦¼ ì „ì†¡ ì‹œì‘... (1~5ë‹¨ê³„, 2ì´ˆ ê°„ê²©)');

            fetch(`${serverUrl}/api/test/send-danger-level-alerts`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                mode: 'cors'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    addSocketLog(`âœ… ìœ„í—˜ë„ë³„ ì•Œë¦¼ ì „ì†¡ ì‹œì‘: ${data.message}`);
                } else {
                    addSocketLog(`âŒ ìœ„í—˜ë„ë³„ ì•Œë¦¼ ì „ì†¡ ì‹¤íŒ¨: ${data.message}`);
                }
            })
            .catch(error => {
                addSocketLog(`âŒ ìœ„í—˜ë„ë³„ ì•Œë¦¼ ì „ì†¡ ì˜¤ë¥˜: ${error.message}`);
            });
        }

        function clearSocketLog() {
            document.getElementById('socketResult').innerHTML = 'WebSocket ë¡œê·¸ê°€ ì§€ì›Œì¡ŒìŠµë‹ˆë‹¤.';
        }

        function addSocketLog(message) {
            const socketResult = document.getElementById('socketResult');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}\n`;
            
            if (socketResult.innerHTML === 'WebSocket ì—°ê²° ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ì‹¤ì‹œê°„ ì•Œë¦¼ì„ í…ŒìŠ¤íŠ¸í•˜ì„¸ìš”.\n\nğŸ“‹ ì‚¬ìš©ë²•:\n1. \'ì†Œì¼“ ì—°ê²°\' ë²„íŠ¼ í´ë¦­\n2. \'í¬ë¡¤ë§ + AI í†µí•© ì‹¤í–‰\' ë²„íŠ¼ìœ¼ë¡œ ì‹¤ì œ ì•Œë¦¼ í™•ì¸\n3. \'í…ŒìŠ¤íŠ¸ ì•Œë¦¼ ì „ì†¡\' ë²„íŠ¼ìœ¼ë¡œ ìˆ˜ë™ ì•Œë¦¼ í…ŒìŠ¤íŠ¸' ||
                socketResult.innerHTML === 'WebSocket ë¡œê·¸ê°€ ì§€ì›Œì¡ŒìŠµë‹ˆë‹¤.') {
                socketResult.innerHTML = logEntry;
            } else {
                socketResult.innerHTML += logEntry;
            }
            
            // ìë™ ìŠ¤í¬ë¡¤
            socketResult.scrollTop = socketResult.scrollHeight;
        }

        function updateSocketStatus(connected) {
            const statusElement = document.getElementById('socketStatus');
            const connectBtn = document.getElementById('socketConnectBtn');
            const disconnectBtn = document.getElementById('socketDisconnectBtn');
            
            if (connected) {
                statusElement.innerHTML = 'ì—°ê²°ë¨';
                statusElement.className = 'socket-connected';
                connectBtn.disabled = true;
                disconnectBtn.disabled = false;
            } else {
                statusElement.innerHTML = 'ì—°ê²° í•´ì œë¨';
                statusElement.className = 'socket-disconnected';
                connectBtn.disabled = false;
                disconnectBtn.disabled = true;
            }
        }

        // ìœ„í—˜ë„ ë ˆë²¨ëª… ë°˜í™˜ í•¨ìˆ˜ ì¶”ê°€
        function getDangerLevelName(dangerDetailId) {
            const dangerLevels = {
                1: 'ê°•ë„',
                2: 'ì„±í­í–‰', 
                3: 'í­í–‰',
                4: 'ì ˆë„',
                5: 'ì‚´ì¸'
            };
            return dangerLevels[dangerDetailId] || 'ì•Œ ìˆ˜ ì—†ìŒ';
        }

        // ================== ê¸°ì¡´ í•¨ìˆ˜ë“¤ ==================

        function executeCrawling() {
            executeRequest('/api/test/crawling/execute', 'ğŸ•·ï¸ í¬ë¡¤ë§ ì‹¤í–‰ ì¤‘...', 'crawlingBtn');
        }

        function executeCrawlingWithAI() {
            executeRequest('/api/test/crawling/with-ai', 'ğŸš€ í¬ë¡¤ë§ + AI í†µí•© ì‹¤í–‰ ì¤‘...\nì‹œê°„ì´ ì˜¤ë˜ ê±¸ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.', 'combinedBtn');
        }

        function executeAiKeyword() {
            const articleDirectory = document.getElementById('articleDirectory').value;
            const url = `/api/test/ai-keyword/execute?articleDirectory=${encodeURIComponent(articleDirectory)}`;
            executeRequest(url, 'ğŸ¤– AI í‚¤ì›Œë“œ ì¶”ì¶œ ì‹¤í–‰ ì¤‘...', 'aiBtn');
        }

        function executeAiWithRange() {
            const articleDirectory = document.getElementById('articleDirectory').value;
            const range = document.getElementById('rangeInput').value.trim();
            
            if (!range) {
                alert('ë²”ìœ„ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”. (ì˜ˆ: 1-5, 1,3,5, all)');
                return;
            }
            
            const url = `/api/test/ai-keyword/execute?articleDirectory=${encodeURIComponent(articleDirectory)}&range=${encodeURIComponent(range)}`;
            executeRequest(url, `ğŸ“ ë²”ìœ„ ì§€ì • AI ì‹¤í–‰ ì¤‘... (${range})`, null);
        }

        function executeAiWithCrawlNum() {
            const articleDirectory = document.getElementById('articleDirectory').value;
            const crawlNum = document.getElementById('crawlNumInput').value;
            
            if (!crawlNum || crawlNum < 1) {
                alert('í¬ë¡¤ë§ ê°œìˆ˜ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”. (1 ì´ìƒì˜ ìˆ«ì)');
                return;
            }
            
            const url = `/api/test/ai-keyword/execute?articleDirectory=${encodeURIComponent(articleDirectory)}&crawlNum=${crawlNum}`;
            executeRequest(url, `ğŸ”¢ ê°œìˆ˜ ê¸°ë°˜ AI ì‹¤í–‰ ì¤‘... (1-${crawlNum})`, null);
        }

        function executeRequest(endpoint, loadingMessage, buttonId) {
            const serverUrl = getServerUrl();
            if (!serverUrl) return;

            const resultDiv = document.getElementById('result');
            const button = buttonId ? document.getElementById(buttonId) : null;
            const originalButtonText = button ? button.textContent : '';
            
            // ë²„íŠ¼ ìƒíƒœ ë³€ê²½
            disableAllButtons(true);
            if (button) button.textContent = 'ì‹¤í–‰ ì¤‘...';
            resultDiv.innerHTML = `<div class="loading">${loadingMessage}</div>`;
            
            const startTime = Date.now();
            
            fetch(serverUrl + endpoint, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                mode: 'cors'
            })
            .then(response => response.text())
            .then(data => {
                const duration = Math.round((Date.now() - startTime) / 1000);
                
                try {
                    const jsonData = JSON.parse(data);
                    displayResult(jsonData, duration);
                } catch (e) {
                    resultDiv.innerHTML = `<div class="success">âœ… ì‹¤í–‰ ì™„ë£Œ (${duration}ì´ˆ)</div><pre>${data}</pre>`;
                }
            })
            .catch(error => {
                const duration = Math.round((Date.now() - startTime) / 1000);
                resultDiv.innerHTML = `<div class="error">âŒ ìš”ì²­ ì‹¤íŒ¨ (${duration}ì´ˆ): ${error.message}</div>`;
            })
            .finally(() => {
                disableAllButtons(false);
                if (button) button.textContent = originalButtonText;
            });
        }

        function displayResult(jsonData, duration) {
            const resultDiv = document.getElementById('result');
            const isSuccess = jsonData.success || 
                            (jsonData.crawling && jsonData.crawling.success) ||
                            (jsonData.aiKeywordExtraction && jsonData.aiKeywordExtraction.success);
            
            let resultHtml = '';
            
            if (isSuccess) {
                resultHtml = `<div class="success">âœ… ì‹¤í–‰ ì™„ë£Œ (${duration}ì´ˆ)</div>`;
                
                // í†µí•© ì‹¤í–‰ ê²°ê³¼ íŠ¹ë³„ ì²˜ë¦¬
                if (jsonData.crawling && jsonData.aiKeywordExtraction) {
                    const crawlNum = jsonData.crawlNum || 0;
                    const aiResults = jsonData.aiKeywordExtraction.results || [];
                    
                    resultHtml += `\n\nğŸ“Š ì‹¤í–‰ ìš”ì•½:`;
                    resultHtml += `\nğŸ•·ï¸ í¬ë¡¤ë§: ${crawlNum}ê°œ ê¸°ì‚¬`;
                    resultHtml += `\nğŸ¤– AI ì²˜ë¦¬: ${aiResults.length}ê°œ íŒŒì¼`;
                    
                    if (aiResults.length > 0) {
                        resultHtml += `\n\nğŸ¯ AI í‚¤ì›Œë“œ ì¶”ì¶œ ê²°ê³¼:`;
                        aiResults.forEach((result, index) => {
                            resultHtml += `\n${index + 1}. ${result.alert_sentence}`;
                        });
                    }
                }
                
                // ë‹¨ìˆœ AI ì‹¤í–‰ ê²°ê³¼
                else if (jsonData.results) {
                    resultHtml += `\n\nğŸ¯ ì²˜ë¦¬ ê²°ê³¼ (${jsonData.processed_files}/${jsonData.total_files}):`;
                    jsonData.results.forEach((result, index) => {
                        resultHtml += `\n${index + 1}. ${result.alert_sentence}`;
                    });
                    
                    if (jsonData.target_numbers) {
                        resultHtml += `\n\nğŸ“‹ ì²˜ë¦¬ ë²”ìœ„: ${jsonData.target_numbers.join(', ')}`;
                    }
                }
                
                resultHtml += '\n\nğŸ“‹ ì „ì²´ ì‘ë‹µ:';
                resultHtml += `<pre>${JSON.stringify(jsonData, null, 2)}</pre>`;
            } else {
                resultHtml = `<div class="error">âŒ ì‹¤í–‰ ì‹¤íŒ¨ (${duration}ì´ˆ)</div><pre>${JSON.stringify(jsonData, null, 2)}</pre>`;
            }
            
            resultDiv.innerHTML = resultHtml;
        }

        function disableAllButtons(disabled) {
            const buttons = document.querySelectorAll('button:not(#socketConnectBtn):not(#socketDisconnectBtn)');
            buttons.forEach(button => button.disabled = disabled);
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ WebSocket ìƒíƒœ ì´ˆê¸°í™”
        window.addEventListener('beforeunload', function() {
            if (stompClient && stompClient.connected) {
                stompClient.deactivate();
            }
        });
    </script>
</body>
</html>